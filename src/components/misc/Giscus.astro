---
import { AUTO_MODE, DARK_MODE } from "@constants/constants";
import { giscusConfig } from "@/config";

interface Props {
	class?: string;
}

if (!giscusConfig.enable) return null;

const config = {
	repo: giscusConfig.repo,
	repoId: giscusConfig.repoId,
	category: giscusConfig.category,
	categoryId: giscusConfig.categoryId,
	mapping: giscusConfig.mapping || "pathname",
	reactionsEnabled: giscusConfig.reactionsEnabled !== false,
	emitMetadata: giscusConfig.emitMetadata || false,
	inputPosition: giscusConfig.inputPosition || "bottom",
	theme: giscusConfig.theme || "preferred_color_scheme",
	lang: giscusConfig.lang || "zh-CN",
	loading: giscusConfig.loading || "lazy",
};
---

<div class={`giscus-container onload-animation ${Astro.props.class || ""}`}>
	<div id="giscus-root"></div>
</div>

<script define:vars={{ config, AUTO_MODE, DARK_MODE }}>
	function getTheme() {
		if (config.theme !== "preferred_color_scheme") return config.theme;
		const theme = localStorage.getItem("theme") || AUTO_MODE;
		const isDark = theme === DARK_MODE || (theme === AUTO_MODE && window.matchMedia("(prefers-color-scheme: dark)").matches) || document.documentElement.classList.contains("dark");
		return isDark ? "noborder_dark" : "noborder_light";
	}

	function load() {
		if (document.querySelector('script[src*="giscus.app/client.js"]')) return;
		const script = document.createElement("script");
		script.src = "https://giscus.app/client.js";
		script.setAttribute("data-repo", config.repo);
		script.setAttribute("data-repo-id", config.repoId);
		script.setAttribute("data-category", config.category);
		script.setAttribute("data-category-id", config.categoryId);
		script.setAttribute("data-mapping", config.mapping);
		script.setAttribute("data-reactions-enabled", config.reactionsEnabled ? "1" : "0");
		script.setAttribute("data-emit-metadata", config.emitMetadata ? "1" : "0");
		script.setAttribute("data-input-position", config.inputPosition);
		script.setAttribute("data-theme", getTheme());
		script.setAttribute("data-lang", config.lang);
		script.setAttribute("data-loading", config.loading);
		script.setAttribute("crossorigin", "anonymous");
		script.async = true;
		document.getElementById("giscus-root")?.appendChild(script);
	}

	function updateTheme() {
		const iframe = document.querySelector('iframe[src*="giscus.app"]');
		iframe?.contentWindow?.postMessage({ giscus: { setConfig: { theme: getTheme() } } }, "https://giscus.app");
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", load);
	} else load();

	new MutationObserver(updateTheme).observe(document.documentElement, { attributes: true, attributeFilter: ["class"] });
	window.addEventListener("storage", (e) => e.key === "theme" && updateTheme());
	window.swup?.hooks.on("content:replace", () => {
		document.querySelector('script[src*="giscus.app/client.js"]')?.remove();
		const root = document.getElementById("giscus-root");
		if (root) root.innerHTML = "";
		load();
	});
</script>
